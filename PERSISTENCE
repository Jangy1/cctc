----------------------------------------------------------OS PERSISTENCE----------------------------------------------------------------------------                                                                                              
dir /R = Recursive search a directory 
more < = Shows contentsd of hidden objects
dir /a /s searchterm* = Searches for certain filename / directory
Get-Item = display a specific registry key and its properties
Get-Content reminder.txt -stream secret.info
sudo -l = displays commands the user may run with elevated permissions
sc query
sc qdescription

ls -l /proc/1/exe.
V      V      V
If it points to /usr/lib/systemd/systemd or similar, the system uses systemd.
If it points to /sbin/init, it likely uses SysV init or a SysV-compatible alternative

-------------------Persistence through a service----------------------------------
Get-CimInstance -classname win32_service | select displayname
tasklist /m = View all running processes and show loaded dll's for each process
Get-Process
Get-Service name | format-list * = View service and all properties in list

Select Name, ProcessId, ParentProcessId
cat suspicious files

-Verify mbr locating boot signature-
sudo xxd -1 512 -g 1 /dev/sda

-Persistence could be established through-
/boot/grub/x86_64-efi/normal.mod + /boot/grub/grub.cfg

lsmod = List loaded kernel modules

cat /etc/inittab = init reads to select default run levels
/etc/rc#.d = Contains scripts to start/stop daemons
top / htop = show PID and all services correlating and might be running at intervals
Get-Process | Select Name, Id, Description | Sort -Property Id | more


greb -aob "GRUB" mbroken = Sorts binary and locates where the string is at
dd if=mbroken bs=1 skip=446 count=16 2>/dev/nll
cat .boot/grub/grub.cfg = GRUB configuration

ls -lisa /lib/systemd/system/default.target   *List default target unit for system*
cat /lib/systemd/system/default.target        *List contents of default target*
------------------------------------ALWAYS CHECK PROFILES----------------------------------
$PROFILE = Command configs and environmental variables dedicated to certain user, filepaths and scripts included
AllUsersAllHosts
AllUsersCurrentHost
CurrentUserCurrentHost
CurrentUserAllHosts

All Users, All Hosts	$PSHOME\Profile.ps1
All Users, Current Host	$PSHOME\Microsoft.PowerShell_profile.ps1
Current User, All Hosts	$HOME\Documents\WindowsPowerShell\Profile.ps1
Current User, Current Host	$HOME\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1

------------------------------LINUX PROFILES---------------------------------------------
/etc/bash.bashrc    * 
/etc/profile    *Executes whenever a user logs in to a shell*

--------------------------REGISTRY PERSISTENCE-------------------------------
reg query '<path\to\subkey>' *Enumerates specific subkey you are looking for*                                            -System processes will not execute from user directories-

      -System-wide and per-user autoruns-
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKU\ < SID > \Software\Microsoft\Windows\CurrentVersion\Run
HKU\ < SID > \Software\Microsoft\Windows\CurrentVersion\RunOnce
HKLM\SYSTEM\CurrentControlSet\services
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
HKLM\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\Winlogon

-Run keys execute programs at logon-
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
HKCU\Software\Microsoft\Windows\CurrentVersion\Run

-Services persist via registry-backed config-
HKLM\SYSTEM\CurrentControlSet\Services

-Per user persistence-
HKU\<SID>\Software\Microsoft\Windows\CurrentVersion\Run

-Wireless network connections-
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles

-User Profiles that have connected to the system*
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList
------------------------------------------NETWORK COMMANDS-----------------------------------------------------------
-View active network connections and listening ports-
Get-NetTCPConnection -State Established 
                            Listen

-Correlate PID to process-
Get-NetTCPConnection | Select LocalPort, RemoteAddress, State, OwningProcess
Get-Process -Id <PID>

netstat -ano = All connection and listening ports, numerically, owning PID, executable responisible for the connection
-----------------------------------USEFUL TOOLS----------------------------------------------------------------------------
-AutoRuns- *How persistence survives reboot*
-Process Monitor-    PPID *IMPORTANT*
-TCPView-   *Network*
-PSExec-    -s | -i| -c
-PsLoggedon- *Who is logged on*
-PsList- *running processes only*
-Procexp- *Explains what process is doing*
-Strings- *Extracts text from binary or text files*
-Handle- *Shows handles being used/opened currently* Handles are data that represents open instances(Files, Keys, etc)
-ListDLL's- *shows Dll's for specific executables*
            listdlls.exe <executable.exe>

-sigcheck- *File version and signature viewer* 
            sigcheck -m "exe path"
------------------------------------------------------------------------------------------------------
sc queryex type=service state=all *Show all services running or not*

HKLM\SYSTEM\CurrentControlSet\Services\Service_Name\Parameters *holds a service's .dll location*

get-service *show displayname and servicename*
sc showsid <service> *show sid of service*


/proc/<PID>/exe *Inspect a running process*
ps --ppid 2 -lf | head
                                                                                                              -All PID lead back to 1 or 2-
                                                                                                                                  user  kernel
sudo lsof | tail -30 *View file descriptors and list all open files being used by every process*

sudo lsof -i :<port#> *Associate port# to process names*

htop *able to list orphan processes when sorted*

sudo lsof  -p <PID> *searches based off PID*

systemctl list-units --type=service *Search for services in Linux*
                                                                               /lib/systemd/system *Contains services, targets, timers, etc*
                                                                               C:\Windows\system32  *Key locations for DLL's*
                                                                               C:\Windows\syswow64                   
systemctl list-timers --all   *List all timers on linux systemd*
                                                                               cron daemon checks the directories /var/spool/cron, /etc/cron.d and the file /etc/crontab

/var/spool/cron/crontabs/ *User cron job*
/etc/crontab    *System cron job*
cat *.service | grep -E 'searchterm'

systemctl status <PID>

HKEY_USERS\*    *Show every logged on user at once*

JumpLists *Form of persistence*

C:\Windows\Prefetch   *Some of these files created when an application runs for the first time*

C:\Users\<USER>\AppData\Roaming     *Reveals app + files requently or recently accessed or used* 

HKCU\Software\Microsoft\Windows\CurrnetVersiob\Explorer\RecentDocs       *Last 150 files or folders opened*
                                                                  \.txt

auditpol /get /category:*    *all auditing files* Auditing = who did what, when, and where.

Get-Eventlog / Get-WinEvent / wevtutil

Key event ID's = 4103 , Verbos CMD Exec
                 4104 , Full script conetents decoded
                 4105 , Engine start
                 4106 , Engine stop

dir /TA   *Access time and date*

        *Search for txt files recently opened*
Get-Item "REGISTRY::HKEY_USERS\*\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs\.txt" | select -Expand property | ForEach-Object {
    [System.Text.Encoding]::Default.GetString((Get-ItemProperty -Path "REGISTRY::HKEY_USERS\*\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs\.txt" -Name $_).$_)
}


        *Shows programs that were run and when they were executed*
Get-Childitem -Path C:\Windows\Prefetch -ErrorAction Continue | select -First 8

-----------------------------------------LOGS-------------------------------------------
journalctl -e  *Jump to most recent entries*
journalctl -b <boot id>   * Filter by boot*
journalctl -u ssh.service  *Filter by service*
                            -since "2 days ago"  *Filter by time*

Get-Service -Name * | Format-Table -Property Name, DisplayName -Wrap    *List all service names and display names*

Get-EventLog -LogName <name> | Where-Object {$_.Message -match "specific string"}

      -Search through the entire Security log for a specific string-
Get-Eventlog -LogName Security | ft -wrap | findstr /i StR1nG

Security Log  *Track invalid login attempts*
-wrap  *option that forces all info if its been truncated*
-------------------------------METHODOLOGY FOR MEMORY ANALYSIS--------------------------------------------------------

IDENTIFY ROUGE PROCESSES - Pslist vs. Psscan | Process validity | Multiple of same processes or misspelling 

ANALYZE DLL & HANDLES - DllLIST | DllDump

EXAMINE NETWORK ARTIFACTS - Connetions

HUNT FOR CODE INJECTION - Malfind

DUMP SUSPICIOUS PROCESSES - ProcDump | MemDump | Filescan | Svcscan| Driverirp

CHECK FOR ROOTKIT - Psscan | devicetree

--------------------------------------------USEFUL COMMANDS---------------------------------------------------------------
List users (name wildcard)

*Find the expired accounts that aren't disabled. List the last names in Alphabetical Order, separated with a comma, and no space between.*
(Get-ADUser -Filter {Enabled -eq $true} -Properties AccountExpirationDate | Where-Object {$_.AccountExpirationDate -lt (Get-Date) -and $_.AccountExpirationDate -ne $null} | Sort-Object Surname | Select-Object -ExpandProperty Surname) -join ','

*How to find email addresses in active directory*
Get-ADUser -Filter {Mail -eq 'user@domain.com'} -Properties Name, Mail | Select-Object Name, Mail

*Filter users based on their description*
get-aduser -filter {Description -like "*"} -properties description, surname | select Name, Description, SamAccountName

*Find account that has a password stored using reversible encryption*
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl

*Find accounts that never expire*
Search-ADAccount -PasswordNeverExpires | Where-Object {$_.Enabled -eq $true -and $_.SamAccountName -notlike 'Guest' -and $_.SamAccountName -notlike 'Administrator'}

*Filter by username to find SID*
Get-ADUser -Identity "username" -Properties SID | Select-Object Name, SID

*Find users full name and description*
Get-LocalUser | Where-Object {$_.name -like "Tiff*"}

*Find users full Identity and description*
Get-ADUser -Identity "user" -Properties *

-----------------------------------------*TOOL VERY IMPORTANT*-----------------------------------------------------------------
-AUTORUNS *Shows applications started on boot as well as Registry and file locations for auto-start configs*  \
-TCPVIEW *Shows all TCP and UDP endpoints with local and remote addresses*                                      \  VERY USEFUL WHEN 
-TASK SCHEDULER *View task history*                                                                             /  USED TOGETHER
-REGEDIT *View, create and modify Windows Registry*                                                           /




